<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: "Cairo", sans-serif; }
    table { border-collapse: collapse; width: 100%; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-7xl mx-auto bg-white shadow-lg rounded-2xl p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-gray-800">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h1>
      <input id="searchInput" type="text" placeholder="ğŸ” Ø¨Ø­Ø«..." 
             class="border rounded-lg px-3 py-2 text-sm w-64 focus:ring-2 focus:ring-blue-500 outline-none" 
             onkeyup="filterRows()" />
    </div>

    <div class="overflow-x-auto border rounded-lg">
      <table id="visitsTable" class="text-sm text-right w-full">
        <thead class="bg-gray-200 text-gray-700">
          <tr>
            <th class="p-2">ğŸ•“ Ø§Ù„ÙˆÙ‚Øª</th>
            <th class="p-2">ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th class="p-2">ğŸŒ Ø§Ù„Ø¯ÙˆÙ„Ø©</th>
            <th class="p-2">ğŸ’» Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
            <th class="p-2">ğŸ”¢ IP</th>
            <th class="p-2">ğŸ”— Ø§Ù„ØµÙØ­Ø©</th>
          </tr>
        </thead>
        <tbody class="text-gray-700"></tbody>
      </table>
    </div>

    <p id="status" class="text-center text-gray-400 text-xs mt-3">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
  </div>

  <script>
    function detectDevice(ua) {
      if (!ua) return "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
      const lower = ua.toLowerCase();
      if (lower.includes("mobile") || lower.includes("android") || lower.includes("iphone")) return "ğŸ“± Ù…ÙˆØ¨Ø§ÙŠÙ„";
      if (lower.includes("windows") || lower.includes("macintosh") || lower.includes("linux")) return "ğŸ’» ÙƒÙ…Ø¨ÙŠÙˆØªØ±";
      return "ğŸ“Ÿ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±";
    }

    async function loadVisits() {
      const status = document.getElementById("status");
      const tbody = document.querySelector("#visitsTable tbody");
      status.textContent = "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
      tbody.innerHTML = "";

      try {
        const res = await fetch("/api/visits");
        if (!res.ok) throw new Error("Unauthorized or failed to fetch");
        const data = await res.json();

        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ©
        const ignoredExt = [".js", ".css", ".png", ".jpg", ".jpeg", ".gif", ".svg", ".ico", ".ttf", ".woff", ".woff2", ".eot", ".otf"];
        const filtered = data.filter(v => {
          if (!v.url) return false;
          const lower = v.url.toLowerCase();
          return !ignoredExt.some(ext => lower.endsWith(ext)) && !lower.includes("/fonts/");
        });

        filtered.forEach(v => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-gray-50 border-b border-gray-200";

          const createdAt = v.created_at ? new Date(v.created_at).toLocaleString("ar-EG") : "-";
          const user = v.user_name || "-";
          const country = v.country || "-";
          const code = v.country_code ? `(${v.country_code})` : "";
          const ip = v.ip || "-";
          const url = v.url || "-";
          const deviceType = detectDevice(v.user_agent);

          tr.innerHTML = `
            <td class="p-2">${createdAt}</td>
            <td class="p-2 font-semibold">${user}</td>
            <td class="p-2">${country} ${code}</td>
            <td class="p-2">${deviceType}</td>
            <td class="p-2">${ip}</td>
            <td class="p-2 text-blue-600 break-all">${url}</td>
          `;

          tbody.appendChild(tr);
        });

        status.textContent = `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${filtered.length} Ø²ÙŠØ§Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙÙŠØ©`;
      } catch (err) {
        console.error("Error loading visits:", err);
        status.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
      }
    }

    function filterRows() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#visitsTable tbody tr");
      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
      });
    }

    loadVisits();
  </script>
</body>
</html>
